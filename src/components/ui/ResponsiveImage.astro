---
interface Props {
  src: string;
  alt: string;
  class?: string;
  width?: number | string;
  height?: number | string;
  loading?: "eager" | "lazy";
  sizes?: string;
  priority?: boolean;
  objectFit?: "contain" | "cover" | "fill" | "none" | "scale-down";
  aspectRatio?: string;
}

const {
  src,
  alt,
  class: className = "",
  width,
  height,
  loading = "lazy",
  sizes = "(max-width: 475px) 100vw, (max-width: 640px) 90vw, (max-width: 768px) 75vw, (max-width: 1024px) 50vw, 33vw",
  priority = false,
  objectFit = "contain",
  aspectRatio,
} = Astro.props;

// Determine if the image is already WebP format
const isWebP = src.toLowerCase().endsWith(".webp");
---

<img
  src={src}
  alt={alt}
  loading={priority ? "eager" : loading}
  width={width}
  height={height}
  sizes={sizes}
  class:list={[
    className,
    "responsive-image",
    { "priority-image": priority },
    { "has-aspect-ratio": aspectRatio }
  ]}
  decoding={priority || loading === "eager" ? "sync" : "async"}
  fetchpriority={priority ? "high" : "auto"}
  style={`
    max-width: 100%;
    height: auto;
    object-fit: ${objectFit};
    ${aspectRatio ? `aspect-ratio: ${aspectRatio};` : ''}
  `}
  role="img"
  tabindex="0"
/>

<style>
  .responsive-image {
    display: block;
    transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
    border-radius: 0.375rem; /* rounded-md */
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
  }

  /* Priority images load faster */
  .priority-image {
    will-change: transform;
  }

  /* Aspect ratio container */
  .has-aspect-ratio {
    width: 100%;
    height: auto;
  }

  /* Hover and focus effects */
  .responsive-image:hover,
  .responsive-image:focus {
    transform: scale(1.02);
    opacity: 0.9;
  }

  /* Focus management */
  .responsive-image:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }

  /* Loading state */
  .responsive-image[loading="lazy"] {
    opacity: 0;
    animation: fadeIn 0.3s ease-in-out forwards;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* Responsive breakpoints */
  @media (max-width: 475px) {
    .responsive-image {
      border-radius: 0.25rem; /* rounded */
    }
  }

  @media (min-width: 1024px) {
    .responsive-image {
      border-radius: 0.5rem; /* rounded-lg */
    }
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .responsive-image {
      transition: none;
      animation: none;
    }
    
    .responsive-image:hover,
    .responsive-image:focus {
      transform: none;
    }
    
    .responsive-image[loading="lazy"] {
      opacity: 1;
      animation: none;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .responsive-image {
      border: 1px solid currentColor;
    }
  }

  /* Dark mode adjustments */
  @media (prefers-color-scheme: dark) {
    .responsive-image {
      box-shadow: 0 1px 3px 0 rgb(255 255 255 / 0.1), 0 1px 2px -1px rgb(255 255 255 / 0.1);
    }
  }

  /* Performance optimization */
  .responsive-image:not(.priority-image) {
    will-change: auto;
  }

  .responsive-image:hover,
  .responsive-image:focus {
    will-change: transform;
  }

  .responsive-image:not(:hover):not(:focus) {
    will-change: auto;
  }
</style>
